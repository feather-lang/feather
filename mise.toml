[env]
_.path = "./bin"

[tasks."build:harness"]
description = "Builds the test harness runner"
run = """
cd harness
go build -o $MISE_CONFIG_ROOT/bin/harness ./cmd/harness
"""

[tasks."build:feather-tester"]
description = "Builds the feather-tester binary"
depends = ["build:core"]
run = """
go build -o $MISE_CONFIG_ROOT/bin/feather-tester ./cmd/feather-tester
"""

[tasks."build:core"]
description = "Builds the core interpreter as a static library"
run = """
mkdir -p build
for f in src/*.c; do
  # Skip host.c for native builds - only needed for WASM import-based host
  [ "$(basename "$f")" = "host.c" ] && continue
  cc -c -fPIC -I src -o "build/$(basename "$f" .c).o" "$f"
done
ar rcs build/libfeather.a build/*.o
"""

[tasks."build:oracle"]
description = "Builds the oracle (reference TCL interpreter)"
dir = "oracle"
run = """
cc -o $MISE_PROJECT_ROOT/bin/oracle \
  $(pkg-config --cflags tcl) \
  main.c \
  $(pkg-config --libs tcl)
"""

[tasks."build:wasm"]
description = "Builds feather.wasm for JavaScript/browser embedding"
dir = "js"
run = "mise run build"

[tasks."test:wasm-memory"]
description = "Run the WASM memory test checking for leaks"
dir = "js"
run = "mise run test:wasm-memory"

[tasks."build:feather-httpd"]
description = "Builds the feather-httpd example server"
depends = ["build:core"]
run = """
go build -o $MISE_CONFIG_ROOT/bin/feather-httpd ./cmd/feather-httpd
"""

[tasks.build]
description = "build all binaries in bin/"
depends = ["build:core", "build:harness", "build:feather-tester"]

[tasks.test]
description = "Run the test harness"
depends = ["build"]
usage = """
arg "path" default="testcases/"
"""
run = """
harness run --host bin/feather-tester $usage_path
"""

[tasks."test:js"]
description = "Run the test harness with the JavaScript host"
depends = ["build:harness", "build:wasm"]
run = """
harness run --host js/tester.js testcases/
"""

[tasks."test:all"]
description = "Run all test suites in parallel"
depends = ["test", "test:js"]
