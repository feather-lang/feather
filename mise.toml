[env]
_.path = "./bin"

[tasks."build:harness"]
description = "Builds the test harness runner"
run = """
cd harness
go build -o $MISE_CONFIG_ROOT/bin/harness ./cmd/harness
"""

[tasks."build:bench"]
description = "Builds the benchmark runner"
run = """
cd harness
go build -o $MISE_CONFIG_ROOT/bin/bench ./cmd/bench
"""

[tasks."build:feather-tester"]
description = "Builds the feather-tester binary"
run = """
go build -a -o $MISE_CONFIG_ROOT/bin/feather-tester ./cmd/feather-tester
"""

[tasks."build:oracle"]
description = "Builds the oracle (reference TCL interpreter)"
dir = "oracle"
run = """
cc -o $MISE_PROJECT_ROOT/bin/oracle \
  $(pkg-config --cflags tcl) \
  main.c \
  $(pkg-config --libs tcl)
"""

[tasks."build:wasm"]
description = "Builds feather.wasm for JavaScript/browser embedding"
dir = "js"
run = "mise run build"

[tasks."build:c-shared"]
description = "Builds libfeather shared library from Go package"
run = """
go build -buildmode=c-shared -o $MISE_PROJECT_ROOT/bin/libfeather.so ./cmd/libfeather
# Move generated header to bin/ for C compilation
mv libfeather.h $MISE_PROJECT_ROOT/bin/ 2>/dev/null || true
# On macOS, fix the install name to use @rpath
if [ "$(uname)" = "Darwin" ]; then
  install_name_tool -id @rpath/libfeather.so $MISE_PROJECT_ROOT/bin/libfeather.so
fi
"""

[tasks."build:c-shared:cross"]
description = "Cross-compile libfeather using zig (targets: linux-amd64, linux-arm64, windows-amd64)"
usage = """
arg "target" help="Target platform: linux-amd64, linux-arm64, windows-amd64"
"""
run = """
set -e
TARGET="$usage_target"

case "$TARGET" in
  linux-amd64)
    GOOS=linux GOARCH=amd64 ZIG_TARGET=x86_64-linux-gnu EXT=so
    ;;
  linux-arm64)
    GOOS=linux GOARCH=arm64 ZIG_TARGET=aarch64-linux-gnu EXT=so
    ;;
  windows-amd64)
    GOOS=windows GOARCH=amd64 ZIG_TARGET=x86_64-windows-gnu EXT=dll
    ;;
  *)
    echo "Unknown target: $TARGET"
    echo "Available targets: linux-amd64, linux-arm64, windows-amd64"
    exit 1
    ;;
esac

mkdir -p $MISE_PROJECT_ROOT/bin/cross

echo "Cross-compiling for $TARGET (zig target: $ZIG_TARGET)..."
CGO_ENABLED=1 GOOS=$GOOS GOARCH=$GOARCH \
  CC="zig cc -target $ZIG_TARGET" \
  go build -buildmode=c-shared \
  -o $MISE_PROJECT_ROOT/bin/cross/libfeather-$TARGET.$EXT \
  ./cmd/libfeather

# Header is generated with the output name, rename it
mv libfeather-$TARGET.h $MISE_PROJECT_ROOT/bin/cross/libfeather.h 2>/dev/null || true

echo "Built: bin/cross/libfeather-$TARGET.$EXT"
"""

[tasks."build:feather-c"]
description = "Builds the feather-c binary (C host)"
depends = ["build:c-shared"]
run = """
if [ "$(uname)" = "Darwin" ]; then
  RPATH_FLAG="-Wl,-rpath,@executable_path"
else
  RPATH_FLAG='-Wl,-rpath,$ORIGIN'
fi
cc -o $MISE_PROJECT_ROOT/bin/feather-c \
  -I$MISE_PROJECT_ROOT/bin \
  -L$MISE_PROJECT_ROOT/bin \
  $RPATH_FLAG \
  c/tester.c \
  -lfeather
"""

[tasks."test:wasm-memory"]
description = "Run the WASM memory test checking for leaks"
dir = "js"
run = "mise run test:wasm-memory"

[tasks."test:go-memory"]
description = "Run the Go memory test checking for leaks"
depends = ["build:feather-memory-tester"]
run = "bin/feather-memory-tester"

[tasks."build:feather-httpd"]
description = "Builds the feather-httpd example server"
run = """
go build -o $MISE_CONFIG_ROOT/bin/feather-httpd ./cmd/feather-httpd
"""

[tasks."build:feather-memory-tester"]
description = "Builds the feather-memory-tester binary"
run = """
go build -o $MISE_CONFIG_ROOT/bin/feather-memory-tester ./cmd/feather-memory-tester
"""

[tasks.build]
description = "build all binaries in bin/"
depends = ["build:harness", "build:bench", "build:feather-tester"]

[tasks.test]
description = "Run the test harness"
depends = ["build"]
usage = """
arg "path" default="testcases/"
"""
run = """
harness run --host bin/feather-tester $usage_path
"""

[tasks."test:js"]
description = "Run the test harness with the JavaScript host"
depends = ["build:harness", "build:wasm"]
run = """
harness run --host js/tester.js testcases/
"""

[tasks."test:c"]
description = "Run the test harness with the C host"
depends = ["build:harness", "build:feather-c"]
usage = """
arg "path" default="testcases/"
"""
run = """
harness run --host bin/feather-c $usage_path
"""

[tasks."test:all"]
description = "Run all test suites in parallel"
depends = ["test", "test:js", "test:c"]

[tasks.bench]
description = "Run benchmarks with the Go host"
depends = ["build:bench", "build:feather-tester"]
usage = """
arg "path" default="benchmarks/"
"""
run = """
bench -host bin/feather-tester $usage_path*.html
"""

[tasks."bench:js"]
description = "Run benchmarks with the JavaScript host"
depends = ["build:bench", "build:wasm"]
run = """
bench -host js/tester.js benchmarks/*.html
"""

[tasks."bench:oracle"]
description = "Run benchmarks with the TCL Oracle (reference TCL interpreter)"
depends = ["build:bench", "build:oracle"]
run = """
bench -host bin/oracle benchmarks/*.html
"""

[tasks."bench:c"]
description = "Run benchmarks with the C host"
depends = ["build:bench", "build:feather-c"]
run = """
bench -host bin/feather-c benchmarks/*.html
"""

[tasks."bench:all"]
description = "Run all benchmarks in parallel"
depends = ["bench", "bench:js", "bench:oracle", "bench:c"]

[tools]
go = "1.25.5"
zig = "latest"
