[env]
_.path = "./bin"

[tasks."build:harness"]
description = "Builds the test harness runner"
run = """
cd harness
go build -o $MISE_CONFIG_ROOT/bin/harness ./cmd/harness
"""

[tasks."build:gcl"]
description = "Builds the Go host (gcl)"
depends = ["build:core"]
run = """
go build -o $MISE_CONFIG_ROOT/bin/gcl ./cmd/gcl
"""

[tasks."build:core"]
description = "Builds the core interpreter as a dynamic library"
run = """
mkdir -p build
cc -shared -fPIC -o build/libtclc.dylib src/*.c -I src
"""

[tasks."build:oracle"]
description = "Builds the oracle (reference TCL interpreter)"
dir = "oracle"
run = """
cc -o $MISE_PROJECT_ROOT/bin/oracle \
  $(pkg-config --cflags tcl) \
  main.c \
  $(pkg-config --libs tcl)
"""

[tasks.build]
description = "build all binaries in bin/"
depends = ["build:core", "build:harness", "build:gcl"]

[tasks.test]
description = "Run the test harness"
depends = ["build"]
run = """
harness run --host bin/gcl testcases/
"""

[tasks."build:wasm"]
description = "Builds tclc as a WASM module"
run = """
mkdir -p wasmtcl/wasm
zig cc -target wasm32-freestanding -nostdlib \
  -Wl,--no-entry \
  -Wl,--export=tcl_script_eval \
  -Wl,--export=tcl_interp_init \
  -Wl,--export=tcl_parse_init \
  -Wl,--export=tcl_parse_command \
  -Wl,--export=tcl_command_exec \
  -Wl,--export=tcl_strlen \
  -Wl,--export=tcl_subst \
  -Wl,--export=tcl_glob_match \
  -Wl,--export=tcl_script_eval_obj \
  -Wl,--export=tcl_builtin_set \
  -Wl,--export=tcl_builtin_expr \
  -Wl,--export=__heap_base \
  -o wasmtcl/wasm/tclc.wasm src/*.c -I src
"""
