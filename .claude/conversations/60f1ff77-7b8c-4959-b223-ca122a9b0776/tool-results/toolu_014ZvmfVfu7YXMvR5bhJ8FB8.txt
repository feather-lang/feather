     1→# TCLC Makefile
     2→# TCL Core Implementation - Build and Test Orchestration
     3→
     4→.PHONY: all clean test test-c test-integration oracle oracle-all diff diff-all loop prompt help features deps check-tools harness libs build build-all build-go
     5→
     6→# Configuration
     7→CC ?= clang
     8→CFLAGS = -Wall -Wextra -Werror -std=c11 -g -O2
     9→GO = go
    10→TCLSH ?= tclsh
    11→
    12→# Directories
    13→CORE_DIR = core
    14→HOST_C_DIR = hosts/c
    15→HOST_GO_DIR = hosts/go
    16→SPEC_DIR = spec
    17→HARNESS_DIR = harness
    18→BUILD_DIR = build
    19→BIN_DIR = bin
    20→
    21→# Source files
    22→CORE_SRCS = $(CORE_DIR)/lexer.c $(CORE_DIR)/parser.c $(CORE_DIR)/subst.c \
    23→            $(CORE_DIR)/eval.c $(CORE_DIR)/builtins.c $(CORE_DIR)/builtin_expr.c \
    24→            $(CORE_DIR)/builtin_global.c $(CORE_DIR)/builtin_upvar.c $(CORE_DIR)/builtin_uplevel.c \
    25→            $(CORE_DIR)/builtin_string.c $(CORE_DIR)/builtin_dict.c
    26→HOST_C_SRCS = $(HOST_C_DIR)/host.c $(HOST_C_DIR)/object.c $(HOST_C_DIR)/vars.c \
    27→              $(HOST_C_DIR)/arena.c $(HOST_C_DIR)/channel.c $(HOST_C_DIR)/main.c
    28→
    29→# Object files
    30→CORE_OBJS = $(patsubst $(CORE_DIR)/%.c,$(BUILD_DIR)/%.o,$(CORE_SRCS))
    31→HOST_C_OBJS = $(patsubst $(HOST_C_DIR)/%.c,$(BUILD_DIR)/host_%.o,$(HOST_C_SRCS))
    32→
    33→# Libraries
    34→LIBTCLC_STATIC = $(BUILD_DIR)/libtclc.a
    35→LIBTCLC_DYNAMIC = $(BUILD_DIR)/libtclc.dylib
    36→
    37→# Binaries
    38→TCLC = $(BIN_DIR)/tclc
    39→TCLGO = $(BIN_DIR)/tclgo
    40→HARNESS = $(BIN_DIR)/harness
    41→
    42→# Default target
    43→all: help
    44→
    45→# Help
    46→help:
    47→	@echo "TCLC - TCL Core Implementation"
    48→	@echo ""
    49→	@echo "Build targets:"
    50→	@echo "  make build          - Build bin/tclc (C host)"
    51→	@echo "  make build-go       - Build bin/tclgo (Go host)"
    52→	@echo "  make build-all      - Build all binaries and libraries"
    53→	@echo "  make libs           - Build libraries only (build/libtclc.a, build/libtclc.dylib)"
    54→	@echo "  make harness        - Build bin/harness (test harness)"
    55→	@echo "  make clean          - Remove build artifacts"
    56→	@echo ""
    57→	@echo "Test targets:"
    58→	@echo "  make test           - Run all tests"
    59→	@echo "  make test-c         - Run C unit tests only"
    60→	@echo "  make test-integration - Run integration tests"
    61→	@echo "  make diff FEATURE=x - Run differential tests for feature x"
    62→	@echo "  make diff-all       - Run differential tests for all features"
    63→	@echo ""
    64→	@echo "Oracle targets:"
    65→	@echo "  make oracle-all     - Generate oracle for all features"
    66→	@echo "  make oracle FEATURE=x - Generate oracle for feature x"
    67→	@echo ""
    68→	@echo "Agent targets:"
    69→	@echo "  make loop FEATURE=x - Run feedback loop for feature x"
    70→	@echo "  make prompt FEATURE=x - Generate agent prompt for feature x"
    71→	@echo ""
    72→	@echo "Info targets:"
    73→	@echo "  make features       - List all features and status"
    74→	@echo "  make deps FEATURE=x - Show dependencies for feature x"
    75→	@echo "  make check-tools    - Verify required tools are installed"
    76→
    77→# Build harness
    78→$(HARNESS): $(BIN_DIR)/.stamp $(wildcard $(HARNESS_DIR)/*.go)
    79→	cd $(HARNESS_DIR) && $(GO) build -o ../$(HARNESS) .
    80→
    81→harness: $(HARNESS)
    82→
    83→# Directory creation (use stamp files to avoid circular dependency)
    84→$(BUILD_DIR)/.stamp:
    85→	mkdir -p $(BUILD_DIR)
    86→	touch $(BUILD_DIR)/.stamp
    87→
    88→$(BIN_DIR)/.stamp:
    89→	mkdir -p $(BIN_DIR)
    90→	touch $(BIN_DIR)/.stamp
    91→
    92→# Core object files
    93→$(BUILD_DIR)/%.o: $(CORE_DIR)/%.c $(CORE_DIR)/tclc.h $(CORE_DIR)/internal.h $(BUILD_DIR)/.stamp
    94→	$(CC) $(CFLAGS) -I$(CORE_DIR) -c -o $@ $<
    95→
    96→# Host C object files
    97→$(BUILD_DIR)/host_%.o: $(HOST_C_DIR)/%.c $(CORE_DIR)/tclc.h $(BUILD_DIR)/.stamp
    98→	$(CC) $(CFLAGS) -I$(CORE_DIR) -c -o $@ $<
    99→
   100→# Static library
   101→$(LIBTCLC_STATIC): $(CORE_OBJS)
   102→	ar rcs $@ $^
   103→
   104→# Dynamic library
   105→$(LIBTCLC_DYNAMIC): $(CORE_OBJS)
   106→	$(CC) $(CFLAGS) -dynamiclib -o $@ $^
   107→
   108→# Library targets
   109→libs: $(LIBTCLC_STATIC) $(LIBTCLC_DYNAMIC)
   110→
   111→# Build tclc interpreter (links statically)
   112→$(TCLC): $(BIN_DIR)/.stamp $(HOST_C_OBJS) $(LIBTCLC_STATIC)
   113→	$(CC) $(CFLAGS) -o $@ $(HOST_C_OBJS) $(LIBTCLC_STATIC)
   114→
   115→# Build Go host
   116→$(TCLGO): $(BIN_DIR)/.stamp $(LIBTCLC_STATIC)
   117→	@if [ -f "$(HOST_GO_DIR)/go.mod" ]; then \
   118→		cd $(HOST_GO_DIR) && CGO_LDFLAGS="-L../../$(BUILD_DIR)" $(GO) build -o ../../$(TCLGO) .; \
   119→	else \
   120→		echo "No Go module yet in $(HOST_GO_DIR)/"; \
   121→		exit 1; \
   122→	fi
   123→
   124→# Build target (all binaries)
   125→build: $(TCLC)
   126→	@echo "Built $(TCLC)"
   127→
   128→# Build all including Go host
   129→build-all: $(TCLC) $(TCLGO) libs
   130→	@echo "Built $(TCLC), $(TCLGO), and libraries"
   131→
   132→# Build Go host only
   133→build-go: $(TCLGO)
   134→	@echo "Built $(TCLGO)"
   135→
   136→# Clean
   137→clean:
   138→	rm -rf $(BUILD_DIR)
   139→	rm -rf $(BIN_DIR)
   140→	rm -f *.o
   141→	rm -f $(HARNESS_DIR)/results/*.json
   142→	rm -f prompt.md
   143→
   144→# C Unit Tests
   145→test-c: $(BUILD_DIR)/.stamp
   146→	@echo "Running C unit tests..."
   147→	@if [ -d "$(CORE_DIR)/test" ] && ls $(CORE_DIR)/test/*.c 1> /dev/null 2>&1; then \
   148→		$(CC) $(CFLAGS) -I$(CORE_DIR) $(CORE_DIR)/test/*.c -lm -o $(BUILD_DIR)/test_runner && \
   149→		$(BUILD_DIR)/test_runner; \
   150→	else \
   151→		echo "No C tests found in $(CORE_DIR)/test/"; \
   152→	fi
   153→
   154→# Integration Tests
   155→test-integration:
   156→	@echo "Running integration tests..."
   157→	@if [ -f "$(HOST_DIR)/go.mod" ]; then \
   158→		cd $(HOST_DIR) && $(GO) test -v ./...; \
   159→	else \
   160→		echo "No Go module yet in $(HOST_DIR)/"; \
   161→	fi
   162→
   163→# All Tests
   164→test: test-c test-integration
   165→
   166→# Oracle Generation - Generate expected outputs from real tclsh
   167→oracle-all: $(HARNESS)
   168→	@TCLSH=$(TCLSH) $(HARNESS) oracle
   169→
   170→oracle: $(HARNESS)
   171→ifndef FEATURE
   172→	$(error FEATURE is required. Usage: make oracle FEATURE=lexer)
   173→endif
   174→	@TCLSH=$(TCLSH) $(HARNESS) oracle $(FEATURE)
   175→
   176→# Differential Testing - Compare our implementation against oracle
   177→diff: $(HARNESS) $(TCLC)
   178→ifndef FEATURE
   179→	$(error FEATURE is required. Usage: make diff FEATURE=lexer)
   180→endif
   181→	@TCLC_INTERP=$(TCLC) $(HARNESS) diff $(FEATURE)
   182→
   183→# Run differential tests for all features
   184→diff-all: $(HARNESS) $(TCLC)
   185→	@TCLC_INTERP=$(TCLC) $(HARNESS) diff
   186→
   187→# Agent Prompt Generation
   188→prompt: $(HARNESS)
   189→ifndef FEATURE
   190→	$(error FEATURE is required. Usage: make prompt FEATURE=lexer)
   191→endif
   192→	@$(HARNESS) prompt $(FEATURE)
   193→
   194→# Feedback Loop - Iterate until all tests pass
   195→loop: $(HARNESS) $(TCLC)
   196→ifndef FEATURE
   197→	$(error FEATURE is required. Usage: make loop FEATURE=lexer)
   198→endif
   199→	@TCLSH=$(TCLSH) TCLC_INTERP=$(TCLC) $(HARNESS) loop $(FEATURE)
   200→
   201→# Feature Information
   202→features: $(HARNESS)
   203→	@$(HARNESS) features
   204→
   205→deps: $(HARNESS)
   206→ifndef FEATURE
   207→	$(error FEATURE is required. Usage: make deps FEATURE=subst)
   208→endif
   209→	@$(HARNESS) deps $(FEATURE)
   210→
   211→# Check for required tools
   212→check-tools:
   213→	@echo "Checking required tools..."
   214→	@which $(CC) > /dev/null 2>&1 && echo "✓ $(CC)" || echo "✗ $(CC) not found"
   215→	@which $(GO) > /dev/null 2>&1 && echo "✓ $(GO)" || echo "✗ $(GO) not found"
   216→	@which $(TCLSH) > /dev/null 2>&1 && echo "✓ $(TCLSH)" || echo "✗ $(TCLSH) not found (needed for oracle)"
   217→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
