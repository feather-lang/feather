     1→# Feature Queue
     2→
     3→This document defines the ordered list of features to implement, their dependencies, and acceptance criteria.
     4→
     5→## Feature Dependency Graph
     6→
     7→```
     8→                                    ┌─────────┐
     9→                                    │  lexer  │
    10→                                    └────┬────┘
    11→                                         │
    12→                                    ┌────▼────┐
    13→                                    │ parser  │
    14→                                    └────┬────┘
    15→                                         │
    16→                    ┌────────────────────┼────────────────────┐
    17→                    │                    │                    │
    18→               ┌────▼────┐         ┌─────▼─────┐        ┌─────▼─────┐
    19→               │  subst  │         │ variables │        │  commands │
    20→               └────┬────┘         └─────┬─────┘        └─────┬─────┘
    21→                    │                    │                    │
    22→                    └────────────────────┼────────────────────┘
    23→                                         │
    24→                                    ┌────▼────┐
    25→                                    │  eval   │
    26→                                    └────┬────┘
    27→                                         │
    28→              ┌──────────────────────────┼──────────────────────────┐
    29→              │                          │                          │
    30→         ┌────▼────┐               ┌─────▼─────┐              ┌─────▼─────┐
    31→         │  expr   │               │  control  │              │   proc    │
    32→         └────┬────┘               └─────┬─────┘              └─────┬─────┘
    33→              │                          │                          │
    34→              │                          │                    ┌─────▼─────┐
    35→              │                          │                    │   scope   │
    36→              │                          │                    │(upvar/up- │
    37→              │                          │                    │  level)   │
    38→              │                          │                    └─────┬─────┘
    39→              │                          │                          │
    40→              └──────────────────────────┼──────────────────────────┘
    41→                                         │
    42→                              ┌──────────┼──────────┐
    43→                              │          │          │
    44→                        ┌─────▼───┐ ┌────▼────┐ ┌───▼────┐
    45→                        │  list   │ │ string  │ │  dict  │
    46→                        └─────────┘ └─────────┘ └────────┘
    47→                                         │
    48→                              ┌──────────┼──────────┐
    49→                              │          │          │
    50→                        ┌─────▼───┐ ┌────▼────┐ ┌───▼────┐
    51→                        │  array  │ │  error  │ │   io   │
    52→                        └─────────┘ └─────────┘ └────────┘
    53→                                         │
    54→                              ┌──────────┼──────────┐
    55→                              │          │          │
    56→                        ┌─────▼───┐ ┌────▼────┐ ┌───▼─────┐
    57→                        │  event  │ │  interp │ │coroutine│
    58→                        └─────────┘ └─────────┘ └─────────┘
    59→```
    60→
    61→## Phase 1: Core Language
    62→
    63→### 1.1 lexer
    64→
    65→**Description:** Tokenize TCL source into words, respecting quoting rules.
    66→
    67→**Dependencies:** None
    68→
    69→**Key behaviors:**
    70→- Word boundaries (whitespace, semicolon, newline)
    71→- Brace quoting `{...}` - no substitution, nesting
    72→- Double quote quoting `"..."` - substitution occurs
    73→- Backslash-newline continuation
    74→- Comments (`#` at command start)
    75→
    76→**Tests:**
    77→- `lexer-1.*` - Basic word splitting
    78→- `lexer-2.*` - Brace quoting
    79→- `lexer-3.*` - Double quote quoting
    80→- `lexer-4.*` - Backslash sequences
    81→- `lexer-5.*` - Comments
    82→- `lexer-6.*` - Edge cases
    83→
    84→**Source files:**
    85→- `core/lexer.c`
    86→
    87→---
    88→
    89→### 1.2 parser
    90→
    91→**Description:** Parse token stream into command structure.
    92→
    93→**Dependencies:** `lexer`
    94→
    95→**Key behaviors:**
    96→- Command = list of words
    97→- Script = list of commands separated by newline/semicolon
    98→- Track source locations for error messages
    99→
   100→**Tests:**
   101→- `parser-1.*` - Single commands
   102→- `parser-2.*` - Multi-command scripts
   103→- `parser-3.*` - Nested structures
   104→
   105→**Source files:**
   106→- `core/parser.c`
   107→
   108→---
   109→
   110→### 1.3 subst
   111→
   112→**Description:** Variable, command, and backslash substitution.
   113→
   114→**Dependencies:** `lexer`, `parser`
   115→
   116→**Key behaviors:**
   117→- `$name` and `${name}` variable substitution
   118→- `$arr(key)` array element substitution
   119→- `[cmd args]` command substitution (recursive eval)
   120→- Backslash escapes: `\n`, `\t`, `\xHH`, `\uHHHH`, `\\`, `\$`, `\[`
   121→- Substitution in double quotes, not in braces
   122→
   123→**Tests:**
   124→- `subst-1.*` - Variable substitution
   125→- `subst-2.*` - Command substitution
   126→- `subst-3.*` - Backslash substitution
   127→- `subst-4.*` - Mixed substitution
   128→- `subst-5.*` - Edge cases
   129→
   130→**Source files:**
   131→- `core/subst.c`
   132→
   133→---
   134→
   135→### 1.4 variables
   136→
   137→**Description:** Variable storage and retrieval.
   138→
   139→**Dependencies:** `lexer`, `parser`
   140→
   141→**Key behaviors:**
   142→- `set` command (read and write)
   143→- `unset` command
   144→- Frame-local variables
   145→- Global frame access
   146→
   147→**Tests:**
   148→- `var-1.*` - Basic set/get
   149→- `var-2.*` - Unset
   150→- `var-3.*` - Non-existent variables
   151→
   152→**Source files:**
   153→- `core/builtins.c` (set, unset commands)
   154→
   155→---
   156→
   157→### 1.5 commands
   158→
   159→**Description:** Command dispatch infrastructure.
   160→
   161→**Dependencies:** `lexer`, `parser`
   162→
   163→**Key behaviors:**
   164→- Builtin lookup (C table)
   165→- Proc lookup (host table)
   166→- Extension lookup (host callback)
   167→- Unknown command handler
   168→
   169→**Tests:**
   170→- `cmd-1.*` - Builtin dispatch
   171→- `cmd-2.*` - Unknown command error
   172→- `cmd-3.*` - Rename command
   173→
   174→**Source files:**
   175→- `core/eval.c`
   176→
   177→---
   178→
   179→### 1.6 eval
   180→
   181→**Description:** Command evaluation trampoline.
   182→
   183→**Dependencies:** `subst`, `variables`, `commands`
   184→
   185→**Key behaviors:**
   186→- Non-recursive evaluation (for coroutine support)
   187→- Proper result propagation
   188→- Error handling
   189→
   190→**Tests:**
   191→- `eval-1.*` - Basic evaluation
   192→- `eval-2.*` - Nested evaluation
   193→- `eval-3.*` - eval command
   194→
   195→**Source files:**
   196→- `core/eval.c`
   197→
   198→---
   199→
   200→## Phase 2: Control Flow and Procedures
   201→
   202→### 2.1 expr
   203→
   204→**Description:** Expression parser and evaluator.
   205→
   206→**Dependencies:** `eval`
   207→
   208→**Key behaviors:**
   209→- Arithmetic: `+ - * / %`
   210→- Comparison: `== != < > <= >=`
   211→- Logical: `&& || !`
   212→- Bitwise: `& | ^ ~ << >>`
   213→- Math functions: `sin cos sqrt pow abs int double round`
   214→- String comparison: `eq ne`
   215→- Ternary: `? :`
   216→- Parentheses for grouping
   217→
   218→**Tests:**
   219→- `expr-1.*` - Arithmetic
   220→- `expr-2.*` - Comparison
   221→- `expr-3.*` - Logical
   222→- `expr-4.*` - Functions
   223→- `expr-5.*` - Precedence
   224→- `expr-6.*` - Edge cases
   225→
   226→**Source files:**
   227→- `core/expr.c`
   228→
   229→---
   230→
   231→### 2.2 control
   232→
   233→**Description:** Control flow commands.
   234→
   235→**Dependencies:** `eval`, `expr`
   236→
   237→**Key behaviors:**
   238→- `if`/`elseif`/`else`
   239→- `while`
   240→- `for`
   241→- `foreach`
   242→- `switch`
   243→- `break`, `continue`
   244→
   245→**Tests:**
   246→- `if-*` - Conditional execution
   247→- `while-*` - While loops
   248→- `for-*` - For loops
   249→- `foreach-*` - List iteration
   250→- `switch-*` - Switch statement
   251→- `break-*` - Break from loops
   252→- `continue-*` - Continue in loops
   253→
   254→**Source files:**
   255→- `core/builtins.c`
   256→
   257→---
   258→
   259→### 2.3 proc
   260→
   261→**Description:** Procedure definition and invocation.
   262→
   263→**Dependencies:** `eval`
   264→
   265→**Key behaviors:**
   266→- `proc name args body`
   267→- Argument binding
   268→- Default argument values
   269→- `args` for varargs
   270→- `return` command
   271→- Proper frame creation
   272→
   273→**Tests:**
   274→- `proc-1.*` - Basic procedures
   275→- `proc-2.*` - Arguments
   276→- `proc-3.*` - Default values
   277→- `proc-4.*` - Varargs
   278→- `proc-5.*` - Return values
   279→
   280→**Source files:**
   281→- `core/builtins.c`
   282→- `core/eval.c`
   283→
   284→---
   285→
   286→### 2.4 scope
   287→
   288→**Description:** Scope manipulation commands.
   289→
   290→**Dependencies:** `proc`
   291→
   292→**Key behaviors:**
   293→- `upvar` - Link to variable in calling frame
   294→- `uplevel` - Execute in calling frame
   295→- `global` - Link to global variable
   296→- `variable` - Namespace variable (simplified)
   297→
   298→**Tests:**
   299→- `upvar-*` - Upvar linking
   300→- `uplevel-*` - Uplevel execution
   301→- `global-*` - Global access
   302→
   303→**Source files:**
   304→- `core/builtins.c`
   305→
   306→---
   307→
   308→## Phase 3: Data Structures
   309→
   310→### 3.1 list
   311→
   312→**Description:** List manipulation commands.
   313→
   314→**Dependencies:** `eval`
   315→
   316→**Key behaviors:**
   317→- `list` - Create list
   318→- `lindex` - Get element
   319→- `llength` - Get length
   320→- `lrange` - Get range
   321→- `lappend` - Append to list variable
   322→- `linsert` - Insert elements
   323→- `lreplace` - Replace elements
   324→- `lset` - Set element
   325→- `lsort` - Sort list
   326→- `lsearch` - Search list
   327→- `lmap` - Map over list
   328→- `concat` - Concatenate lists
   329→- `join` - Join with separator
   330→- `split` - Split string into list
   331→
   332→**Tests:**
   333→- `list-*` - All list operations
   334→
   335→**Source files:**
   336→- `core/builtins.c`
   337→
   338→---
   339→
   340→### 3.2 string
   341→
   342→**Description:** String manipulation commands.
   343→
   344→**Dependencies:** `eval`
   345→
   346→**Key behaviors:**
   347→- `string length`
   348→- `string index`
   349→- `string range`
   350→- `string compare`
   351→- `string equal`
   352→- `string match` (glob)
   353→- `string first`, `string last`
   354→- `string map`
   355→- `string tolower`, `string toupper`
   356→- `string trim`, `string trimleft`, `string trimright`
   357→- `string replace`
   358→- `string repeat`
   359→- `string reverse`
   360→- `string is` (type checking)
   361→- `format` (sprintf-style)
   362→- `scan` (sscanf-style)
   363→- `append`
   364→
   365→**Tests:**
   366→- `string-*` - All string operations
   367→- `format-*` - Format command
   368→- `scan-*` - Scan command
   369→
   370→**Source files:**
   371→- `core/builtins.c`
   372→- `core/format.c`
   373→
   374→---
   375→
   376→### 3.3 dict
   377→
   378→**Description:** Dictionary manipulation commands.
   379→
   380→**Dependencies:** `eval`
   381→
   382→**Key behaviors:**
   383→- `dict create`
   384→- `dict get`, `dict set`
   385→- `dict exists`
   386→- `dict keys`, `dict values`
   387→- `dict remove`
   388→- `dict size`
   389→- `dict for`
   390→- `dict map`
   391→- `dict filter`
   392→- `dict merge`
   393→
   394→**Tests:**
   395→- `dict-*` - All dict operations
   396→
   397→**Source files:**
   398→- `core/builtins.c`
   399→
   400→---
   401→
   402→### 3.4 array
   403→
   404→**Description:** Array manipulation commands.
   405→
   406→**Dependencies:** `variables`
   407→
   408→**Key behaviors:**
   409→- `array set`
   410→- `array get`
   411→- `array names`
   412→- `array size`
   413→- `array exists`
   414→- `array unset`
   415→- `parray` (for debugging)
   416→
   417→**Tests:**
   418→- `array-*` - All array operations
   419→
   420→**Source files:**
   421→- `core/builtins.c`
   422→
   423→---
   424→
   425→## Phase 4: Error Handling and I/O
   426→
   427→### 4.1 error
   428→
   429→**Description:** Error handling commands.
   430→
   431→**Dependencies:** `eval`
   432→
   433→**Key behaviors:**
   434→- `catch` - Catch errors
   435→- `try`/`on`/`trap`/`finally` - Structured error handling
   436→- `throw` - Throw error with code
   437→- `error` - Generate error
   438→- `return -code error` - Return as error
   439→- Error info and error code propagation
   440→
   441→**Tests:**
   442→- `catch-*` - Catch errors
   443→- `try-*` - Try/finally
   444→- `error-*` - Error generation
   445→- `throw-*` - Throw errors
   446→
   447→**Source files:**
   448→- `core/builtins.c`
   449→- `core/eval.c`
   450→
   451→---
   452→
   453→### 4.2 io
   454→
   455→**Description:** I/O commands.
   456→
   457→**Dependencies:** `eval`
   458→
   459→**Key behaviors:**
   460→- `puts`, `gets`
   461→- `open`, `close`
   462→- `read`
   463→- `seek`, `tell`, `eof`
   464→- `flush`
   465→- `fconfigure`
   466→- `chan` ensemble
   467→
   468→**Tests:**
   469→- `io-*` - All I/O operations
   470→- `chan-*` - Channel operations
   471→
   472→**Source files:**
   473→- `core/builtins.c`
   474→
   475→---
   476→
   477→## Phase 5: Advanced Features
   478→
   479→### 5.1 event
   480→
   481→**Description:** Event loop commands.
   482→
   483→**Dependencies:** `io`
   484→
   485→**Key behaviors:**
   486→- `after` - Timer events
   487→- `vwait` - Wait for variable
   488→- `fileevent` - Channel events
   489→- `update` - Process pending events
   490→
   491→**Tests:**
   492→- `after-*` - Timer events
   493→- `vwait-*` - Variable wait
   494→- `fileevent-*` - Channel events
   495→
   496→**Source files:**
   497→- `core/builtins.c`
   498→
   499→---
   500→
   501→### 5.2 interp
   502→
   503→**Description:** Multiple interpreter support.
   504→
   505→**Dependencies:** `eval`
   506→
   507→**Key behaviors:**
   508→- `interp create`
   509→- `interp eval`
   510→- `interp alias`
   511→- `interp delete`
   512→- `interp share`, `interp transfer`
   513→- Safe interpreters
   514→
   515→**Tests:**
   516→- `interp-*` - All interpreter operations
   517→
   518→**Source files:**
   519→- `core/interp.c`
   520→- `core/builtins.c`
   521→
   522→---
   523→
   524→### 5.3 coroutine
   525→
   526→**Description:** Coroutine support.
   527→
   528→**Dependencies:** `eval`, `proc`
   529→
   530→**Key behaviors:**
   531→- `coroutine` - Create coroutine
   532→- `yield` - Yield value
   533→- `yieldto` - Yield to specific command
   534→- Coroutine resume on command invocation
   535→- Proper stack save/restore
   536→
   537→**Tests:**
   538→- `coro-*` - All coroutine operations
   539→
   540→**Source files:**
   541→- `core/coro.c`
   542→- `core/eval.c`
   543→
   544→---
   545→
   546→## Phase 6: System Integration
   547→
   548→### 6.1 exec
   549→
   550→**Description:** Subprocess execution.
   551→
   552→**Dependencies:** `io`
   553→
   554→**Key behaviors:**
   555→- `exec` command
   556→- Pipeline support (`|`)
   557→- Redirection (`<`, `>`, `2>`, `>&`)
   558→- Background execution (`&`)
   559→- `pid` command
   560→
   561→**Tests:**
   562→- `exec-*` - Process execution
   563→
   564→**Source files:**
   565→- `core/builtins.c`
   566→
   567→---
   568→
   569→### 6.2 file
   570→
   571→**Description:** File system commands.
   572→
   573→**Dependencies:** `io`
   574→
   575→**Key behaviors:**
   576→- `file exists`, `file isfile`, `file isdirectory`
   577→- `file size`, `file mtime`
   578→- `file delete`, `file rename`, `file copy`, `file mkdir`
   579→- `file dirname`, `file tail`, `file extension`, `file rootname`
   580→- `file join`, `file split`, `file normalize`
   581→- `glob`
   582→- `cd`, `pwd`
   583→
   584→**Tests:**
   585→- `file-*` - All file operations
   586→
   587→**Source files:**
   588→- `core/builtins.c`
   589→
   590→---
   591→
   592→### 6.3 socket
   593→
   594→**Description:** Network socket support.
   595→
   596→**Dependencies:** `io`, `event`
   597→
   598→**Key behaviors:**
   599→- `socket` client connection
   600→- `socket -server` for server sockets
   601→- Async connection support
   602→- Integration with event loop
   603→
   604→**Tests:**
   605→- `socket-*` - Socket operations
   606→
   607→**Source files:**
   608→- `core/builtins.c`
   609→
   610→---
   611→
   612→### 6.4 regex
   613→
   614→**Description:** Regular expression support.
   615→
   616→**Dependencies:** `eval`
   617→
   618→**Key behaviors:**
   619→- `regexp` - Match patterns
   620→- `regsub` - Substitute matches
   621→- Capture groups
   622→- Various flags (`-nocase`, `-all`, `-inline`, etc.)
   623→
   624→**Tests:**
   625→- `regexp-*` - Pattern matching
   626→- `regsub-*` - Substitution
   627→
   628→**Source files:**
   629→- `core/builtins.c`
   630→
   631→---
   632→
   633→### 6.5 info
   634→
   635→**Description:** Introspection commands.
   636→
   637→**Dependencies:** All previous
   638→
   639→**Key behaviors:**
   640→- `info commands`, `info procs`
   641→- `info vars`, `info locals`, `info globals`
   642→- `info exists`
   643→- `info body`, `info args`, `info default`
   644→- `info level`, `info frame`
   645→- `info script`
   646→- `info patchlevel`, `info tclversion`
   647→- `info coroutine`
   648→
   649→**Tests:**
   650→- `info-*` - All introspection
   651→
   652→**Source files:**
   653→- `core/builtins.c`
   654→
   655→---
   656→
   657→### 6.6 namespace
   658→
   659→**Description:** Namespace support.
   660→
   661→**Dependencies:** `eval`, `proc`, `variables`
   662→
   663→**Key behaviors:**
   664→- `namespace eval`
   665→- `namespace current`
   666→- `namespace export`, `namespace import`
   667→- `namespace exists`
   668→- `namespace children`, `namespace parent`
   669→- Qualified names (`::foo::bar`)
   670→- Variable resolution order
   671→
   672→**Tests:**
   673→- `namespace-*` - All namespace operations
   674→
   675→**Source files:**
   676→- `core/namespace.c`
   677→- `core/eval.c`
   678→
   679→---
   680→
   681→## Feature YAML Schema
   682→
   683→```yaml
   684→features:
   685→  - id: string           # Unique identifier
   686→    description: string  # Human-readable description
   687→    depends: [string]    # List of dependency feature IDs
   688→    phase: int           # Implementation phase (1-6)
   689→    status: string       # pending | in_progress | complete
   690→    tests: [string]      # Test file patterns
   691→    source_files:        # Files to modify
   692→      - path: string
   693→        description: string
   694→```
   695→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
