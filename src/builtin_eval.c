#include "feather.h"
#include "internal.h"

FeatherResult feather_builtin_eval(const FeatherHostOps *ops, FeatherInterp interp,
                                   FeatherObj cmd, FeatherObj args) {
  (void)cmd;
  size_t argc = ops->list.length(interp, args);

  if (argc == 0) {
    ops->interp.set_result(interp, ops->string.intern(interp,
      "wrong # args: should be \"eval arg ?arg ...?\"", 44));
    return TCL_ERROR;
  }

  FeatherObj script;

  if (argc == 1) {
    script = ops->list.at(interp, args, 0);
  } else {
    FeatherObj concatArgs = ops->list.create(interp);
    for (size_t i = 0; i < argc; i++) {
      ops->list.push(interp, concatArgs, ops->list.at(interp, args, i));
    }
    FeatherResult res = feather_builtin_concat(ops, interp, cmd, concatArgs);
    if (res != TCL_OK) return res;
    script = ops->interp.get_result(interp);
  }

  ops->interp.set_result(interp, ops->string.intern(interp, "", 0));
  return feather_script_eval_obj(ops, interp, script, 0);
}

void feather_register_eval_usage(const FeatherHostOps *ops, FeatherInterp interp) {
  FeatherObj spec = feather_usage_spec(ops, interp);

  FeatherObj e = feather_usage_about(ops, interp,
    "Evaluate a Tcl script",
    "Concatenates all arguments (in the same fashion as the concat command), "
    "passes the concatenated string to the Tcl interpreter recursively, and returns "
    "the result of that evaluation (or any error generated by it).\n\n"
    "If only a single arg is supplied, it is used directly as the script to evaluate.\n\n"
    "Note that the list command quotes sequences of words in such a way that they are "
    "not further expanded by eval; for any values $a, $b, and $c, these two lines are "
    "effectively equivalent:\n\n"
    "    eval [list $a $b $c]\n\n"
    "    $a $b $c");
  spec = feather_usage_add(ops, interp, spec, e);

  e = feather_usage_arg(ops, interp, "<arg>");
  e = feather_usage_help(ops, interp, e, "Script to evaluate, or first part of script if multiple arguments are provided");
  e = feather_usage_type(ops, interp, e, "script");
  spec = feather_usage_add(ops, interp, spec, e);

  e = feather_usage_arg(ops, interp, "?arg?...");
  e = feather_usage_help(ops, interp, e, "Additional parts of the script to concatenate before evaluation");
  e = feather_usage_type(ops, interp, e, "script");
  spec = feather_usage_add(ops, interp, spec, e);

  e = feather_usage_example(ops, interp,
    "eval {set x 10}",
    "Evaluate a simple script that sets a variable",
    NULL);
  spec = feather_usage_add(ops, interp, spec, e);

  e = feather_usage_example(ops, interp,
    "eval set x 10",
    "Concatenate multiple arguments into \"set x 10\" and evaluate",
    NULL);
  spec = feather_usage_add(ops, interp, spec, e);

  e = feather_usage_example(ops, interp,
    "set cmd \"puts\"\nset arg \"Hello\"\neval $cmd $arg",
    "Build and evaluate a command from variables",
    NULL);
  spec = feather_usage_add(ops, interp, spec, e);

  e = feather_usage_section(ops, interp, "See Also",
    "catch(1), concat(1), list(1), subst(1), uplevel(1)");
  spec = feather_usage_add(ops, interp, spec, e);

  feather_usage_register(ops, interp, "eval", spec);
}
