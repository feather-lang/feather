[tasks.build]
description = "Builds feather.wasm using zig cc"
run = """
zig wasm-ld --no-entry \
  --allow-undefined \
  --export=feather_interp_init \
  --export=feather_script_eval \
  --export=feather_script_eval_obj \
  --export=feather_command_exec \
  --export=feather_parse_init \
  --export=feather_parse_command \
  --export=feather_subst \
  --export=feather_list_parse \
  --export=feather_get_ops \
  --export=alloc \
  --export=free \
  --export=feather_arena_reset \
  --export=feather_arena_used \
  --export=wasm_call_compare \
  --import-memory \
  -o feather.wasm \
  $(for f in ../src/*.c; do
    # Skip amalgamation - it's for cgo only
    [ "$(basename "$f")" = "feather_amalgamation.c" ] && continue
    zig cc -target wasm32-freestanding -Os -c -DFEATHER_WASM_BUILD -I ../src -o /tmp/$(basename $f .c).o $f
    echo /tmp/$(basename $f .c).o
  done)
"""

[tasks.serve]
description = "Serve the JS host for browser testing"
depends = ["build"]
run = """
python3 -m http.server 8080
"""

[tasks.cli]
description = "Start the feather.js CLI"
depends = ["build"]
run = "node --experimental-wasm-type-reflection cli.js"

[tasks."test:wasm-memory"]
description = "Run stress test to verify arena-based memory management"
depends = ["build"]
run = "node stress-test.js"
